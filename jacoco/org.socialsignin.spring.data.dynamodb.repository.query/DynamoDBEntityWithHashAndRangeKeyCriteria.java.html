<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DynamoDBEntityWithHashAndRangeKeyCriteria.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Spring Data DynamoDB</a> &gt; <a href="index.source.html" class="el_package">org.socialsignin.spring.data.dynamodb.repository.query</a> &gt; <span class="el_source">DynamoDBEntityWithHashAndRangeKeyCriteria.java</span></div><h1>DynamoDBEntityWithHashAndRangeKeyCriteria.java</h1><pre class="source lang-java linenums">/**
 * Copyright Â© 2018 spring-data-dynamodb (https://github.com/spring-data-dynamodb/spring-data-dynamodb)
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.socialsignin.spring.data.dynamodb.repository.query;

import com.amazonaws.services.dynamodbv2.datamodeling.DynamoDBMapperTableModel;
import com.amazonaws.services.dynamodbv2.datamodeling.DynamoDBQueryExpression;
import com.amazonaws.services.dynamodbv2.datamodeling.DynamoDBScanExpression;
import com.amazonaws.services.dynamodbv2.model.ComparisonOperator;
import com.amazonaws.services.dynamodbv2.model.Condition;
import com.amazonaws.services.dynamodbv2.model.QueryRequest;
import org.socialsignin.spring.data.dynamodb.core.DynamoDBOperations;
import org.socialsignin.spring.data.dynamodb.query.CountByHashAndRangeKeyQuery;
import org.socialsignin.spring.data.dynamodb.query.MultipleEntityQueryExpressionQuery;
import org.socialsignin.spring.data.dynamodb.query.MultipleEntityQueryRequestQuery;
import org.socialsignin.spring.data.dynamodb.query.MultipleEntityScanExpressionQuery;
import org.socialsignin.spring.data.dynamodb.query.Query;
import org.socialsignin.spring.data.dynamodb.query.QueryExpressionCountQuery;
import org.socialsignin.spring.data.dynamodb.query.QueryRequestCountQuery;
import org.socialsignin.spring.data.dynamodb.query.ScanExpressionCountQuery;
import org.socialsignin.spring.data.dynamodb.query.SingleEntityLoadByHashAndRangeKeyQuery;
import org.socialsignin.spring.data.dynamodb.repository.support.DynamoDBIdIsHashAndRangeKeyEntityInformation;
import org.springframework.util.Assert;

import java.util.ArrayList;
import java.util.Arrays;
import java.util.HashMap;
import java.util.HashSet;
import java.util.List;
import java.util.Map;
import java.util.Map.Entry;
import java.util.Set;

/**
 * @author Michael Lavelle
 * @author Sebastian Just
 */
public class DynamoDBEntityWithHashAndRangeKeyCriteria&lt;T, ID&gt; extends AbstractDynamoDBQueryCriteria&lt;T, ID&gt; {

	private Object rangeKeyAttributeValue;
	private Object rangeKeyPropertyValue;
	private String rangeKeyPropertyName;
	private Set&lt;String&gt; indexRangeKeyPropertyNames;
	private DynamoDBIdIsHashAndRangeKeyEntityInformation&lt;T, ID&gt; entityInformation;

	protected String getRangeKeyAttributeName() {
<span class="fc" id="L59">		return getAttributeName(getRangeKeyPropertyName());</span>
	}

	protected String getRangeKeyPropertyName() {
<span class="fc" id="L63">		return rangeKeyPropertyName;</span>
	}

	protected boolean isRangeKeyProperty(String propertyName) {
<span class="fc" id="L67">		return rangeKeyPropertyName.equals(propertyName);</span>
	}

	public DynamoDBEntityWithHashAndRangeKeyCriteria(
	        DynamoDBIdIsHashAndRangeKeyEntityInformation&lt;T, ID&gt; entityInformation, DynamoDBMapperTableModel&lt;T&gt; tableModel) {

<span class="fc" id="L73">	    super(entityInformation, tableModel);</span>
<span class="fc" id="L74">		this.rangeKeyPropertyName = entityInformation.getRangeKeyPropertyName();</span>
<span class="fc" id="L75">		this.indexRangeKeyPropertyNames = entityInformation.getIndexRangeKeyPropertyNames();</span>
<span class="pc bpc" id="L76" title="1 of 2 branches missed.">		if (indexRangeKeyPropertyNames == null) {</span>
<span class="nc" id="L77">			indexRangeKeyPropertyNames = new HashSet&lt;&gt;();</span>
		}
<span class="fc" id="L79">		this.entityInformation = entityInformation;</span>

<span class="fc" id="L81">	}</span>

	public Set&lt;String&gt; getIndexRangeKeyAttributeNames() {
<span class="fc" id="L84">		Set&lt;String&gt; indexRangeKeyAttributeNames = new HashSet&lt;&gt;();</span>
<span class="fc bfc" id="L85" title="All 2 branches covered.">		for (String indexRangeKeyPropertyName : indexRangeKeyPropertyNames) {</span>
<span class="fc" id="L86">			indexRangeKeyAttributeNames.add(getAttributeName(indexRangeKeyPropertyName));</span>
<span class="fc" id="L87">		}</span>
<span class="fc" id="L88">		return indexRangeKeyAttributeNames;</span>
	}

	protected Object getRangeKeyAttributeValue() {
<span class="fc" id="L92">		return rangeKeyAttributeValue;</span>
	}

	protected Object getRangeKeyPropertyValue() {
<span class="fc" id="L96">		return rangeKeyPropertyValue;</span>
	}

	protected boolean isRangeKeySpecified() {
<span class="fc bfc" id="L100" title="All 2 branches covered.">		return getRangeKeyAttributeValue() != null;</span>
	}

	protected Query&lt;T&gt; buildSingleEntityLoadQuery(DynamoDBOperations dynamoDBOperations) {
<span class="fc" id="L104">		return new SingleEntityLoadByHashAndRangeKeyQuery&lt;&gt;(dynamoDBOperations, entityInformation.getJavaType(),</span>
<span class="fc" id="L105">				getHashKeyPropertyValue(), getRangeKeyPropertyValue());</span>
	}
	
	protected Query&lt;Long&gt; buildSingleEntityCountQuery(DynamoDBOperations dynamoDBOperations) {
<span class="nc" id="L109">		return new CountByHashAndRangeKeyQuery&lt;&gt;(dynamoDBOperations, entityInformation.getJavaType(),</span>
<span class="nc" id="L110">				getHashKeyPropertyValue(), getRangeKeyPropertyValue());</span>
	}

	private void checkComparisonOperatorPermittedForCompositeHashAndRangeKey(ComparisonOperator comparisonOperator) {

<span class="pc bpc" id="L115" title="2 of 4 branches missed.">		if (!ComparisonOperator.EQ.equals(comparisonOperator) &amp;&amp; !ComparisonOperator.CONTAINS.equals(comparisonOperator)</span>
<span class="pc bpc" id="L116" title="1 of 2 branches missed.">				&amp;&amp; !ComparisonOperator.BEGINS_WITH.equals(comparisonOperator)) {</span>
<span class="fc" id="L117">			throw new UnsupportedOperationException(&quot;Only EQ,CONTAINS,BEGINS_WITH supported for composite id comparison&quot;);</span>
		}

<span class="nc" id="L120">	}</span>

	@SuppressWarnings(&quot;unchecked&quot;)
	@Override
	public DynamoDBQueryCriteria&lt;T, ID&gt; withSingleValueCriteria(String propertyName, ComparisonOperator comparisonOperator,
			Object value, Class&lt;?&gt; propertyType) {

<span class="fc bfc" id="L127" title="All 2 branches covered.">		if (entityInformation.isCompositeHashAndRangeKeyProperty(propertyName)) {</span>
<span class="nc" id="L128">			checkComparisonOperatorPermittedForCompositeHashAndRangeKey(comparisonOperator);</span>
<span class="nc" id="L129">			Object hashKey = entityInformation.getHashKey((ID) value);</span>
<span class="nc" id="L130">			Object rangeKey = entityInformation.getRangeKey((ID) value);</span>
<span class="nc bnc" id="L131" title="All 2 branches missed.">			if (hashKey != null) {</span>
<span class="nc" id="L132">				withSingleValueCriteria(getHashKeyPropertyName(), comparisonOperator, hashKey, hashKey.getClass());</span>
			}
<span class="nc bnc" id="L134" title="All 2 branches missed.">			if (rangeKey != null) {</span>
<span class="nc" id="L135">				withSingleValueCriteria(getRangeKeyPropertyName(), comparisonOperator, rangeKey, rangeKey.getClass());</span>
			}
<span class="nc" id="L137">			return this;</span>
		} else {
<span class="fc" id="L139">			return super.withSingleValueCriteria(propertyName, comparisonOperator, value, propertyType);</span>
		}
	}

	public DynamoDBQueryExpression&lt;T&gt; buildQueryExpression() {
<span class="fc" id="L144">		DynamoDBQueryExpression&lt;T&gt; queryExpression = new DynamoDBQueryExpression&lt;T&gt;();</span>
<span class="pc bpc" id="L145" title="1 of 2 branches missed.">		if (isHashKeySpecified()) {</span>
<span class="fc" id="L146">			T hashKeyPrototype = entityInformation.getHashKeyPropotypeEntityForHashKey(getHashKeyPropertyValue());</span>
<span class="fc" id="L147">			queryExpression.withHashKeyValues(hashKeyPrototype);</span>
<span class="fc" id="L148">			queryExpression.withRangeKeyConditions(new HashMap&lt;String, Condition&gt;());</span>
		}

<span class="pc bpc" id="L151" title="3 of 4 branches missed.">		if (isRangeKeySpecified() &amp;&amp; !isApplicableForGlobalSecondaryIndex()) {</span>
<span class="nc" id="L152">			Condition rangeKeyCondition = createSingleValueCondition(getRangeKeyPropertyName(), ComparisonOperator.EQ,</span>
<span class="nc" id="L153">					getRangeKeyAttributeValue(), getRangeKeyAttributeValue().getClass(), true);</span>
<span class="nc" id="L154">			queryExpression.withRangeKeyCondition(getRangeKeyAttributeName(), rangeKeyCondition);</span>
<span class="nc" id="L155">			applySortIfSpecified(queryExpression, Arrays.asList(new String[] { getRangeKeyPropertyName() }));</span>

<span class="pc bfc" id="L157" title="All 2 branches covered.">		} else if (isOnlyASingleAttributeConditionAndItIsOnEitherRangeOrIndexRangeKey()</span>
<span class="pc bpc" id="L158" title="1 of 2 branches missed.">				|| (isApplicableForGlobalSecondaryIndex())) {</span>

<span class="fc" id="L160">			Entry&lt;String, List&lt;Condition&gt;&gt; singlePropertyConditions = propertyConditions.entrySet().iterator().next();</span>

<span class="fc" id="L162">			List&lt;String&gt; allowedSortProperties = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L163" title="All 2 branches covered.">			for (Entry&lt;String, List&lt;Condition&gt;&gt; singlePropertyCondition : propertyConditions.entrySet()) {</span>
<span class="fc" id="L164">				if (entityInformation.getGlobalSecondaryIndexNamesByPropertyName().keySet()</span>
<span class="pc bpc" id="L165" title="1 of 2 branches missed.">						.contains(singlePropertyCondition.getKey())) {</span>
<span class="nc" id="L166">					allowedSortProperties.add(singlePropertyCondition.getKey());</span>
				}
<span class="fc" id="L168">			}</span>
<span class="pc bpc" id="L169" title="1 of 2 branches missed.">			if (allowedSortProperties.size() == 0) {</span>
<span class="fc" id="L170">				allowedSortProperties.add(singlePropertyConditions.getKey());</span>
			}

<span class="fc bfc" id="L173" title="All 2 branches covered.">			for (Entry&lt;String, List&lt;Condition&gt;&gt; singleAttributeConditions : attributeConditions.entrySet()) {</span>
<span class="fc bfc" id="L174" title="All 2 branches covered.">				for (Condition condition : singleAttributeConditions.getValue()) {</span>
<span class="fc" id="L175">					queryExpression.withRangeKeyCondition(singleAttributeConditions.getKey(), condition);</span>
<span class="fc" id="L176">				}</span>
<span class="fc" id="L177">			}</span>

<span class="fc" id="L179">			applySortIfSpecified(queryExpression, allowedSortProperties);</span>
<span class="pc bpc" id="L180" title="1 of 2 branches missed.">			if (getGlobalSecondaryIndexName() != null) {</span>
<span class="nc" id="L181">				queryExpression.setIndexName(getGlobalSecondaryIndexName());</span>
			}
<span class="fc" id="L183">		} else {</span>
<span class="fc" id="L184">			applySortIfSpecified(queryExpression, Arrays.asList(new String[] { getRangeKeyPropertyName() }));</span>
		}

<span class="fc" id="L187">		return queryExpression;</span>
	}

	protected List&lt;Condition&gt; getRangeKeyConditions() {
<span class="fc" id="L191">		List&lt;Condition&gt; rangeKeyConditions = null;</span>
<span class="pc bpc" id="L192" title="1 of 2 branches missed.">		if (isApplicableForGlobalSecondaryIndex()</span>
<span class="fc bfc" id="L193" title="All 2 branches covered.">				&amp;&amp; entityInformation.getGlobalSecondaryIndexNamesByPropertyName().keySet().contains(getRangeKeyPropertyName())) {</span>
<span class="fc bfc" id="L194" title="All 2 branches covered.">			rangeKeyConditions = getRangeKeyAttributeValue() == null ? null : Arrays.asList(createSingleValueCondition(</span>
<span class="fc" id="L195">					getRangeKeyPropertyName(), ComparisonOperator.EQ, getRangeKeyAttributeValue(), getRangeKeyAttributeValue()</span>
<span class="fc" id="L196">							.getClass(), true));</span>

		}
<span class="fc" id="L199">		return rangeKeyConditions;</span>
	}

	protected Query&lt;T&gt; buildFinderQuery(DynamoDBOperations dynamoDBOperations) {
<span class="fc bfc" id="L203" title="All 2 branches covered.">		if (isApplicableForQuery()) {</span>
<span class="fc bfc" id="L204" title="All 2 branches covered.">			if (isApplicableForGlobalSecondaryIndex()) {</span>
<span class="fc" id="L205">				String tableName = dynamoDBOperations.getOverriddenTableName(clazz, entityInformation.getDynamoDBTableName());</span>
<span class="fc" id="L206">				QueryRequest queryRequest = buildQueryRequest(tableName, getGlobalSecondaryIndexName(),</span>
<span class="fc" id="L207">						getHashKeyAttributeName(), getRangeKeyAttributeName(), this.getRangeKeyPropertyName(),</span>
<span class="fc" id="L208">						getHashKeyConditions(), getRangeKeyConditions());</span>
<span class="fc" id="L209">				return new MultipleEntityQueryRequestQuery&lt;T&gt;(dynamoDBOperations,entityInformation.getJavaType(), queryRequest);</span>
			} else {
<span class="fc" id="L211">				DynamoDBQueryExpression&lt;T&gt; queryExpression = buildQueryExpression();</span>
<span class="fc" id="L212">				return new MultipleEntityQueryExpressionQuery&lt;T&gt;(dynamoDBOperations, entityInformation.getJavaType(), queryExpression);</span>
			}
		} else {
<span class="fc" id="L215">			return new MultipleEntityScanExpressionQuery&lt;T&gt;(dynamoDBOperations, clazz, buildScanExpression());</span>
		}
	}
	
	
	protected Query&lt;Long&gt; buildFinderCountQuery(DynamoDBOperations dynamoDBOperations,boolean pageQuery) {
<span class="pc bpc" id="L221" title="1 of 2 branches missed.">		if (isApplicableForQuery()) {</span>
<span class="nc bnc" id="L222" title="All 2 branches missed.">			if (isApplicableForGlobalSecondaryIndex()) {</span>
<span class="nc" id="L223">				String tableName = dynamoDBOperations.getOverriddenTableName(clazz, entityInformation.getDynamoDBTableName());</span>
<span class="nc" id="L224">				QueryRequest queryRequest = buildQueryRequest(tableName, getGlobalSecondaryIndexName(),</span>
<span class="nc" id="L225">						getHashKeyAttributeName(), getRangeKeyAttributeName(), this.getRangeKeyPropertyName(),</span>
<span class="nc" id="L226">						getHashKeyConditions(), getRangeKeyConditions());</span>
<span class="nc" id="L227">				return new QueryRequestCountQuery(dynamoDBOperations, queryRequest);</span>
		
			} else {
<span class="nc" id="L230">				DynamoDBQueryExpression&lt;T&gt; queryExpression = buildQueryExpression();</span>
<span class="nc" id="L231">				return new QueryExpressionCountQuery&lt;T&gt;(dynamoDBOperations, entityInformation.getJavaType(), queryExpression);</span>
		
			}
		} else {
<span class="fc" id="L235">			return new ScanExpressionCountQuery&lt;T&gt;(dynamoDBOperations, clazz, buildScanExpression(),pageQuery);</span>
		}
	}

	@Override
	public boolean isApplicableForLoad() {
<span class="fc bfc" id="L241" title="All 4 branches covered.">		return attributeConditions.size() == 0 &amp;&amp; isHashAndRangeKeySpecified();</span>
	}

	protected boolean isHashAndRangeKeySpecified() {
<span class="fc bfc" id="L245" title="All 4 branches covered.">		return isHashKeySpecified() &amp;&amp; isRangeKeySpecified();</span>
	}

	protected boolean isOnlyASingleAttributeConditionAndItIsOnEitherRangeOrIndexRangeKey() {
<span class="fc" id="L249">		boolean isOnlyASingleAttributeConditionAndItIsOnEitherRangeOrIndexRangeKey = false;</span>
<span class="fc bfc" id="L250" title="All 4 branches covered.">		if (!isRangeKeySpecified() &amp;&amp; attributeConditions.size() == 1) {</span>
<span class="fc" id="L251">			Entry&lt;String, List&lt;Condition&gt;&gt; conditionsEntry = attributeConditions.entrySet().iterator().next();</span>
<span class="fc bfc" id="L252" title="All 2 branches covered.">			if (conditionsEntry.getKey().equals(getRangeKeyAttributeName())</span>
<span class="fc bfc" id="L253" title="All 2 branches covered.">					|| getIndexRangeKeyAttributeNames().contains(conditionsEntry.getKey())) {</span>
<span class="pc bpc" id="L254" title="1 of 2 branches missed.">				if (conditionsEntry.getValue().size() == 1) {</span>
<span class="fc" id="L255">					isOnlyASingleAttributeConditionAndItIsOnEitherRangeOrIndexRangeKey = true;</span>
				}
			}
		}
<span class="fc" id="L259">		return isOnlyASingleAttributeConditionAndItIsOnEitherRangeOrIndexRangeKey;</span>

	}
	
	

	@Override
	protected boolean hasIndexHashKeyEqualCondition() {
	
<span class="fc" id="L268">		boolean hasCondition = super.hasIndexHashKeyEqualCondition();</span>
<span class="fc bfc" id="L269" title="All 2 branches covered.">		if (!hasCondition)</span>
		{
<span class="fc bfc" id="L271" title="All 4 branches covered.">			if (rangeKeyAttributeValue != null &amp;&amp; entityInformation.isGlobalIndexHashKeyProperty(rangeKeyPropertyName))</span>
			{
<span class="fc" id="L273">					hasCondition = true;</span>
			}
		}
<span class="fc" id="L276">		return hasCondition;</span>
	}

	@Override
	protected boolean hasIndexRangeKeyCondition() {
<span class="fc" id="L281">		boolean hasCondition =  super.hasIndexRangeKeyCondition();</span>
<span class="fc bfc" id="L282" title="All 2 branches covered.">		if (!hasCondition)</span>
		{
<span class="fc bfc" id="L284" title="All 4 branches covered.">			if (rangeKeyAttributeValue != null &amp;&amp; entityInformation.isGlobalIndexRangeKeyProperty(rangeKeyPropertyName))</span>
			{
<span class="fc" id="L286">					hasCondition = true;</span>
			}
		}
<span class="fc" id="L289">		return hasCondition;</span>
	}

	protected boolean isApplicableForGlobalSecondaryIndex() {
<span class="fc" id="L293">		boolean global = super.isApplicableForGlobalSecondaryIndex();</span>
<span class="fc bfc" id="L294" title="All 4 branches covered.">		if (global &amp;&amp; getRangeKeyAttributeValue() != null</span>
<span class="pc bpc" id="L295" title="1 of 2 branches missed.">				&amp;&amp; !entityInformation.getGlobalSecondaryIndexNamesByPropertyName().keySet().contains(getRangeKeyPropertyName())) {</span>
<span class="nc" id="L296">			return false;</span>
		}
		
<span class="fc" id="L299">		return global;</span>

	}

	protected String getGlobalSecondaryIndexName() {
		// Get the target global secondary index name using the property
		// conditions
<span class="fc" id="L306">		String globalSecondaryIndexName = super.getGlobalSecondaryIndexName();</span>

		// Hash and Range Entities store range key equals conditions as
		// rangeKeyAttributeValue attribute instead of as property condition
		// Check this attribute and if specified in the query conditions and
		// it's the only global secondary index range candidate,
		// then set the index range key to be that associated with the range key
<span class="fc bfc" id="L313" title="All 2 branches covered.">		if (globalSecondaryIndexName == null) {</span>
<span class="fc bfc" id="L314" title="All 4 branches covered.">			if (this.hashKeyAttributeValue == null &amp;&amp; getRangeKeyAttributeValue() != null) {</span>
<span class="fc" id="L315">				String[] rangeKeyIndexNames = entityInformation.getGlobalSecondaryIndexNamesByPropertyName().get(</span>
<span class="fc" id="L316">						this.getRangeKeyPropertyName());</span>
<span class="pc bpc" id="L317" title="1 of 4 branches missed.">				globalSecondaryIndexName = rangeKeyIndexNames != null &amp;&amp; rangeKeyIndexNames.length &gt; 0 ? rangeKeyIndexNames[0]</span>
<span class="fc" id="L318">						: null;</span>
			}
		}
<span class="fc" id="L321">		return globalSecondaryIndexName;</span>
	}

	public boolean isApplicableForQuery() {

<span class="fc bfc" id="L326" title="All 2 branches covered.">		return isOnlyHashKeySpecified()</span>
<span class="fc bfc" id="L327" title="All 6 branches covered.">				|| (isHashKeySpecified() &amp;&amp; isOnlyASingleAttributeConditionAndItIsOnEitherRangeOrIndexRangeKey() &amp;&amp; comparisonOperatorsPermittedForQuery())</span>
<span class="fc bfc" id="L328" title="All 2 branches covered.">				|| isApplicableForGlobalSecondaryIndex();</span>

	}

	public DynamoDBScanExpression buildScanExpression() {

<span class="fc" id="L334">		ensureNoSort(sort);</span>

<span class="fc" id="L336">		DynamoDBScanExpression scanExpression = new DynamoDBScanExpression();</span>
<span class="fc bfc" id="L337" title="All 2 branches covered.">		if (isHashKeySpecified()) {</span>
<span class="fc" id="L338">			scanExpression.addFilterCondition(</span>
<span class="fc" id="L339">					getHashKeyAttributeName(),</span>
<span class="fc" id="L340">					createSingleValueCondition(getHashKeyPropertyName(), ComparisonOperator.EQ, getHashKeyAttributeValue(),</span>
<span class="fc" id="L341">							getHashKeyAttributeValue().getClass(), true));</span>
		}
<span class="fc bfc" id="L343" title="All 2 branches covered.">		if (isRangeKeySpecified()) {</span>
<span class="fc" id="L344">			scanExpression.addFilterCondition(</span>
<span class="fc" id="L345">					getRangeKeyAttributeName(),</span>
<span class="fc" id="L346">					createSingleValueCondition(getRangeKeyPropertyName(), ComparisonOperator.EQ, getRangeKeyAttributeValue(),</span>
<span class="fc" id="L347">							getRangeKeyAttributeValue().getClass(), true));</span>
		}
<span class="fc bfc" id="L349" title="All 2 branches covered.">		for (Map.Entry&lt;String, List&lt;Condition&gt;&gt; conditionEntry : attributeConditions.entrySet()) {</span>
<span class="fc bfc" id="L350" title="All 2 branches covered.">			for (Condition condition : conditionEntry.getValue()) {</span>
<span class="fc" id="L351">				scanExpression.addFilterCondition(conditionEntry.getKey(), condition);</span>
<span class="fc" id="L352">			}</span>
<span class="fc" id="L353">		}</span>
<span class="fc" id="L354">		return scanExpression;</span>
	}

	public DynamoDBQueryCriteria&lt;T, ID&gt; withRangeKeyEquals(Object value) {
<span class="fc" id="L358">		Assert.notNull(value, &quot;Creating conditions on null range keys not supported: please specify a value for '&quot;</span>
<span class="fc" id="L359">				+ getRangeKeyPropertyName() + &quot;'&quot;);</span>

<span class="fc" id="L361">		rangeKeyAttributeValue = getPropertyAttributeValue(getRangeKeyPropertyName(), value);</span>
<span class="fc" id="L362">		rangeKeyPropertyValue = value;</span>
<span class="fc" id="L363">		return this;</span>
	}

	@SuppressWarnings(&quot;unchecked&quot;)
	@Override
	public DynamoDBQueryCriteria&lt;T, ID&gt; withPropertyEquals(String propertyName, Object value, Class&lt;?&gt; propertyType) {
<span class="fc bfc" id="L369" title="All 2 branches covered.">		if (isHashKeyProperty(propertyName)) {</span>
<span class="fc" id="L370">			return withHashKeyEquals(value);</span>
<span class="fc bfc" id="L371" title="All 2 branches covered.">		} else if (isRangeKeyProperty(propertyName)) {</span>
<span class="fc" id="L372">			return withRangeKeyEquals(value);</span>
<span class="fc bfc" id="L373" title="All 2 branches covered.">		} else if (entityInformation.isCompositeHashAndRangeKeyProperty(propertyName)) {</span>
<span class="fc" id="L374">			Assert.notNull(value,</span>
					&quot;Creating conditions on null composite id properties not supported: please specify a value for '&quot;
							+ propertyName + &quot;'&quot;);
<span class="fc" id="L377">			Object hashKey = entityInformation.getHashKey((ID) value);</span>
<span class="fc" id="L378">			Object rangeKey = entityInformation.getRangeKey((ID) value);</span>
<span class="fc bfc" id="L379" title="All 2 branches covered.">			if (hashKey != null) {</span>
<span class="fc" id="L380">				withHashKeyEquals(hashKey);</span>
			}
<span class="fc bfc" id="L382" title="All 2 branches covered.">			if (rangeKey != null) {</span>
<span class="fc" id="L383">				withRangeKeyEquals(rangeKey);</span>
			}
<span class="fc" id="L385">			return this;</span>
		} else {
<span class="fc" id="L387">			Condition condition = createSingleValueCondition(propertyName, ComparisonOperator.EQ, value, propertyType, false);</span>
<span class="fc" id="L388">			return withCondition(propertyName, condition);</span>
		}

	}

	@Override
	protected boolean isOnlyHashKeySpecified() {
<span class="pc bpc" id="L395" title="1 of 6 branches missed.">		return isHashKeySpecified() &amp;&amp; attributeConditions.size() == 0 &amp;&amp; !isRangeKeySpecified();</span>
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>