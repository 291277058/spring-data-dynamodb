<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DynamoDBEntityWithHashAndRangeKeyCriteria.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Spring Data DynamoDB</a> &gt; <a href="index.source.html" class="el_package">org.socialsignin.spring.data.dynamodb.repository.query</a> &gt; <span class="el_source">DynamoDBEntityWithHashAndRangeKeyCriteria.java</span></div><h1>DynamoDBEntityWithHashAndRangeKeyCriteria.java</h1><pre class="source lang-java linenums">/**
 * Copyright Â© 2018 spring-data-dynamodb (https://github.com/derjust/spring-data-dynamodb)
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.socialsignin.spring.data.dynamodb.repository.query;

import com.amazonaws.services.dynamodbv2.datamodeling.DynamoDBMapperTableModel;
import com.amazonaws.services.dynamodbv2.datamodeling.DynamoDBQueryExpression;
import com.amazonaws.services.dynamodbv2.datamodeling.DynamoDBScanExpression;
import com.amazonaws.services.dynamodbv2.model.ComparisonOperator;
import com.amazonaws.services.dynamodbv2.model.Condition;
import com.amazonaws.services.dynamodbv2.model.QueryRequest;
import com.amazonaws.services.dynamodbv2.model.Select;
import org.socialsignin.spring.data.dynamodb.core.DynamoDBOperations;
import org.socialsignin.spring.data.dynamodb.query.CountByHashAndRangeKeyQuery;
import org.socialsignin.spring.data.dynamodb.query.MultipleEntityQueryExpressionQuery;
import org.socialsignin.spring.data.dynamodb.query.MultipleEntityQueryRequestQuery;
import org.socialsignin.spring.data.dynamodb.query.MultipleEntityScanExpressionQuery;
import org.socialsignin.spring.data.dynamodb.query.Query;
import org.socialsignin.spring.data.dynamodb.query.QueryExpressionCountQuery;
import org.socialsignin.spring.data.dynamodb.query.QueryRequestCountQuery;
import org.socialsignin.spring.data.dynamodb.query.ScanExpressionCountQuery;
import org.socialsignin.spring.data.dynamodb.query.SingleEntityLoadByHashAndRangeKeyQuery;
import org.socialsignin.spring.data.dynamodb.repository.support.DynamoDBIdIsHashAndRangeKeyEntityInformation;
import org.springframework.util.Assert;

import java.util.ArrayList;
import java.util.Arrays;
import java.util.HashMap;
import java.util.HashSet;
import java.util.List;
import java.util.Map;
import java.util.Map.Entry;
import java.util.Set;

/**
 * @author Michael Lavelle
 * @author Sebastian Just
 */
public class DynamoDBEntityWithHashAndRangeKeyCriteria&lt;T, ID&gt; extends AbstractDynamoDBQueryCriteria&lt;T, ID&gt; {

	private Object rangeKeyAttributeValue;
	private Object rangeKeyPropertyValue;
	private String rangeKeyPropertyName;
	private Set&lt;String&gt; indexRangeKeyPropertyNames;
	private DynamoDBIdIsHashAndRangeKeyEntityInformation&lt;T, ID&gt; entityInformation;

	protected String getRangeKeyAttributeName() {
<span class="fc" id="L60">		return getAttributeName(getRangeKeyPropertyName());</span>
	}

	protected String getRangeKeyPropertyName() {
<span class="fc" id="L64">		return rangeKeyPropertyName;</span>
	}

	protected boolean isRangeKeyProperty(String propertyName) {
<span class="fc" id="L68">		return rangeKeyPropertyName.equals(propertyName);</span>
	}

	public DynamoDBEntityWithHashAndRangeKeyCriteria(
			DynamoDBIdIsHashAndRangeKeyEntityInformation&lt;T, ID&gt; entityInformation,
			DynamoDBMapperTableModel&lt;T&gt; tableModel) {

<span class="fc" id="L75">		super(entityInformation, tableModel);</span>
<span class="fc" id="L76">		this.rangeKeyPropertyName = entityInformation.getRangeKeyPropertyName();</span>
<span class="fc" id="L77">		this.indexRangeKeyPropertyNames = entityInformation.getIndexRangeKeyPropertyNames();</span>
<span class="pc bpc" id="L78" title="1 of 2 branches missed.">		if (indexRangeKeyPropertyNames == null) {</span>
<span class="nc" id="L79">			indexRangeKeyPropertyNames = new HashSet&lt;&gt;();</span>
		}
<span class="fc" id="L81">		this.entityInformation = entityInformation;</span>
<span class="fc" id="L82">	}</span>

	public Set&lt;String&gt; getIndexRangeKeyAttributeNames() {
<span class="fc" id="L85">		Set&lt;String&gt; indexRangeKeyAttributeNames = new HashSet&lt;&gt;();</span>
<span class="fc bfc" id="L86" title="All 2 branches covered.">		for (String indexRangeKeyPropertyName : indexRangeKeyPropertyNames) {</span>
<span class="fc" id="L87">			indexRangeKeyAttributeNames.add(getAttributeName(indexRangeKeyPropertyName));</span>
<span class="fc" id="L88">		}</span>
<span class="fc" id="L89">		return indexRangeKeyAttributeNames;</span>
	}

	protected Object getRangeKeyAttributeValue() {
<span class="fc" id="L93">		return rangeKeyAttributeValue;</span>
	}

	protected Object getRangeKeyPropertyValue() {
<span class="fc" id="L97">		return rangeKeyPropertyValue;</span>
	}

	protected boolean isRangeKeySpecified() {
<span class="fc bfc" id="L101" title="All 2 branches covered.">		return getRangeKeyAttributeValue() != null;</span>
	}

	protected Query&lt;T&gt; buildSingleEntityLoadQuery(DynamoDBOperations dynamoDBOperations) {
<span class="fc" id="L105">		return new SingleEntityLoadByHashAndRangeKeyQuery&lt;&gt;(dynamoDBOperations, entityInformation.getJavaType(),</span>
<span class="fc" id="L106">				getHashKeyPropertyValue(), getRangeKeyPropertyValue());</span>
	}

	protected Query&lt;Long&gt; buildSingleEntityCountQuery(DynamoDBOperations dynamoDBOperations) {
<span class="nc" id="L110">		return new CountByHashAndRangeKeyQuery&lt;&gt;(dynamoDBOperations, entityInformation.getJavaType(),</span>
<span class="nc" id="L111">				getHashKeyPropertyValue(), getRangeKeyPropertyValue());</span>
	}

	private void checkComparisonOperatorPermittedForCompositeHashAndRangeKey(ComparisonOperator comparisonOperator) {

<span class="pc bpc" id="L116" title="2 of 4 branches missed.">		if (!ComparisonOperator.EQ.equals(comparisonOperator) &amp;&amp; !ComparisonOperator.CONTAINS.equals(comparisonOperator)</span>
<span class="pc bpc" id="L117" title="1 of 2 branches missed.">				&amp;&amp; !ComparisonOperator.BEGINS_WITH.equals(comparisonOperator)) {</span>
<span class="fc" id="L118">			throw new UnsupportedOperationException(</span>
					&quot;Only EQ,CONTAINS,BEGINS_WITH supported for composite id comparison&quot;);
		}

<span class="nc" id="L122">	}</span>

	@SuppressWarnings(&quot;unchecked&quot;)
	@Override
	public DynamoDBQueryCriteria&lt;T, ID&gt; withSingleValueCriteria(String propertyName,
			ComparisonOperator comparisonOperator, Object value, Class&lt;?&gt; propertyType) {

<span class="fc bfc" id="L129" title="All 2 branches covered.">		if (entityInformation.isCompositeHashAndRangeKeyProperty(propertyName)) {</span>
<span class="nc" id="L130">			checkComparisonOperatorPermittedForCompositeHashAndRangeKey(comparisonOperator);</span>
<span class="nc" id="L131">			Object hashKey = entityInformation.getHashKey((ID) value);</span>
<span class="nc" id="L132">			Object rangeKey = entityInformation.getRangeKey((ID) value);</span>
<span class="nc bnc" id="L133" title="All 2 branches missed.">			if (hashKey != null) {</span>
<span class="nc" id="L134">				withSingleValueCriteria(getHashKeyPropertyName(), comparisonOperator, hashKey, hashKey.getClass());</span>
			}
<span class="nc bnc" id="L136" title="All 2 branches missed.">			if (rangeKey != null) {</span>
<span class="nc" id="L137">				withSingleValueCriteria(getRangeKeyPropertyName(), comparisonOperator, rangeKey, rangeKey.getClass());</span>
			}
<span class="nc" id="L139">			return this;</span>
		} else {
<span class="fc" id="L141">			return super.withSingleValueCriteria(propertyName, comparisonOperator, value, propertyType);</span>
		}
	}

	public DynamoDBQueryExpression&lt;T&gt; buildQueryExpression() {
<span class="fc" id="L146">		DynamoDBQueryExpression&lt;T&gt; queryExpression = new DynamoDBQueryExpression&lt;T&gt;();</span>
<span class="pc bpc" id="L147" title="1 of 2 branches missed.">		if (isHashKeySpecified()) {</span>
<span class="fc" id="L148">			T hashKeyPrototype = entityInformation.getHashKeyPropotypeEntityForHashKey(getHashKeyPropertyValue());</span>
<span class="fc" id="L149">			queryExpression.withHashKeyValues(hashKeyPrototype);</span>
<span class="fc" id="L150">			queryExpression.withRangeKeyConditions(new HashMap&lt;String, Condition&gt;());</span>
		}

<span class="pc bpc" id="L153" title="3 of 4 branches missed.">		if (isRangeKeySpecified() &amp;&amp; !isApplicableForGlobalSecondaryIndex()) {</span>
<span class="nc" id="L154">			Condition rangeKeyCondition = createSingleValueCondition(getRangeKeyPropertyName(), ComparisonOperator.EQ,</span>
<span class="nc" id="L155">					getRangeKeyAttributeValue(), getRangeKeyAttributeValue().getClass(), true);</span>
<span class="nc" id="L156">			queryExpression.withRangeKeyCondition(getRangeKeyAttributeName(), rangeKeyCondition);</span>
<span class="nc" id="L157">			applySortIfSpecified(queryExpression, Arrays.asList(new String[]{getRangeKeyPropertyName()}));</span>

<span class="pc bfc" id="L159" title="All 2 branches covered.">		} else if (isOnlyASingleAttributeConditionAndItIsOnEitherRangeOrIndexRangeKey()</span>
<span class="pc bpc" id="L160" title="1 of 2 branches missed.">				|| (isApplicableForGlobalSecondaryIndex())) {</span>

<span class="fc" id="L162">			Entry&lt;String, List&lt;Condition&gt;&gt; singlePropertyConditions = propertyConditions.entrySet().iterator().next();</span>

<span class="fc" id="L164">			List&lt;String&gt; allowedSortProperties = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L165" title="All 2 branches covered.">			for (Entry&lt;String, List&lt;Condition&gt;&gt; singlePropertyCondition : propertyConditions.entrySet()) {</span>
<span class="fc" id="L166">				if (entityInformation.getGlobalSecondaryIndexNamesByPropertyName().keySet()</span>
<span class="pc bpc" id="L167" title="1 of 2 branches missed.">						.contains(singlePropertyCondition.getKey())) {</span>
<span class="nc" id="L168">					allowedSortProperties.add(singlePropertyCondition.getKey());</span>
				}
<span class="fc" id="L170">			}</span>
<span class="pc bpc" id="L171" title="1 of 2 branches missed.">			if (allowedSortProperties.size() == 0) {</span>
<span class="fc" id="L172">				allowedSortProperties.add(singlePropertyConditions.getKey());</span>
			}

<span class="fc bfc" id="L175" title="All 2 branches covered.">			for (Entry&lt;String, List&lt;Condition&gt;&gt; singleAttributeConditions : attributeConditions.entrySet()) {</span>
<span class="fc bfc" id="L176" title="All 2 branches covered.">				for (Condition condition : singleAttributeConditions.getValue()) {</span>
<span class="fc" id="L177">					queryExpression.withRangeKeyCondition(singleAttributeConditions.getKey(), condition);</span>
<span class="fc" id="L178">				}</span>
<span class="fc" id="L179">			}</span>

<span class="fc" id="L181">			applySortIfSpecified(queryExpression, allowedSortProperties);</span>
<span class="pc bpc" id="L182" title="1 of 2 branches missed.">			if (getGlobalSecondaryIndexName() != null) {</span>
<span class="nc" id="L183">				queryExpression.setIndexName(getGlobalSecondaryIndexName());</span>
			}
<span class="fc" id="L185">		} else {</span>
<span class="fc" id="L186">			applySortIfSpecified(queryExpression, Arrays.asList(new String[]{getRangeKeyPropertyName()}));</span>
		}

<span class="pc bpc" id="L189" title="1 of 2 branches missed.">		if (projection.isPresent()) {</span>
<span class="nc" id="L190">			queryExpression.setSelect(Select.SPECIFIC_ATTRIBUTES);</span>
<span class="nc" id="L191">			queryExpression.setProjectionExpression(projection.get());</span>
		}

<span class="fc" id="L194">		return queryExpression;</span>
	}

	protected List&lt;Condition&gt; getRangeKeyConditions() {
<span class="fc" id="L198">		List&lt;Condition&gt; rangeKeyConditions = null;</span>
<span class="pc bpc" id="L199" title="1 of 2 branches missed.">		if (isApplicableForGlobalSecondaryIndex() &amp;&amp; entityInformation.getGlobalSecondaryIndexNamesByPropertyName()</span>
<span class="fc bfc" id="L200" title="All 2 branches covered.">				.keySet().contains(getRangeKeyPropertyName())) {</span>
<span class="fc bfc" id="L201" title="All 2 branches covered.">			rangeKeyConditions = getRangeKeyAttributeValue() == null</span>
<span class="fc" id="L202">					? null</span>
<span class="fc" id="L203">					: Arrays.asList(createSingleValueCondition(getRangeKeyPropertyName(), ComparisonOperator.EQ,</span>
<span class="fc" id="L204">							getRangeKeyAttributeValue(), getRangeKeyAttributeValue().getClass(), true));</span>

		}
<span class="fc" id="L207">		return rangeKeyConditions;</span>
	}

	protected Query&lt;T&gt; buildFinderQuery(DynamoDBOperations dynamoDBOperations) {
<span class="fc bfc" id="L211" title="All 2 branches covered.">		if (isApplicableForQuery()) {</span>
<span class="fc bfc" id="L212" title="All 2 branches covered.">			if (isApplicableForGlobalSecondaryIndex()) {</span>
<span class="fc" id="L213">				String tableName = dynamoDBOperations.getOverriddenTableName(clazz,</span>
<span class="fc" id="L214">						entityInformation.getDynamoDBTableName());</span>
<span class="fc" id="L215">				QueryRequest queryRequest = buildQueryRequest(tableName, getGlobalSecondaryIndexName(),</span>
<span class="fc" id="L216">						getHashKeyAttributeName(), getRangeKeyAttributeName(), this.getRangeKeyPropertyName(),</span>
<span class="fc" id="L217">						getHashKeyConditions(), getRangeKeyConditions());</span>
<span class="fc" id="L218">				return new MultipleEntityQueryRequestQuery&lt;&gt;(dynamoDBOperations, entityInformation.getJavaType(),</span>
						queryRequest);
			} else {
<span class="fc" id="L221">				DynamoDBQueryExpression&lt;T&gt; queryExpression = buildQueryExpression();</span>
<span class="fc" id="L222">				return new MultipleEntityQueryExpressionQuery&lt;&gt;(dynamoDBOperations, entityInformation.getJavaType(),</span>
						queryExpression);
			}
		} else {
<span class="fc" id="L226">			return new MultipleEntityScanExpressionQuery&lt;&gt;(dynamoDBOperations, clazz, buildScanExpression());</span>
		}
	}

	protected Query&lt;Long&gt; buildFinderCountQuery(DynamoDBOperations dynamoDBOperations, boolean pageQuery) {
<span class="pc bpc" id="L231" title="1 of 2 branches missed.">		if (isApplicableForQuery()) {</span>
<span class="nc bnc" id="L232" title="All 2 branches missed.">			if (isApplicableForGlobalSecondaryIndex()) {</span>
<span class="nc" id="L233">				String tableName = dynamoDBOperations.getOverriddenTableName(clazz,</span>
<span class="nc" id="L234">						entityInformation.getDynamoDBTableName());</span>
<span class="nc" id="L235">				QueryRequest queryRequest = buildQueryRequest(tableName, getGlobalSecondaryIndexName(),</span>
<span class="nc" id="L236">						getHashKeyAttributeName(), getRangeKeyAttributeName(), this.getRangeKeyPropertyName(),</span>
<span class="nc" id="L237">						getHashKeyConditions(), getRangeKeyConditions());</span>
<span class="nc" id="L238">				return new QueryRequestCountQuery(dynamoDBOperations, queryRequest);</span>

			} else {
<span class="nc" id="L241">				DynamoDBQueryExpression&lt;T&gt; queryExpression = buildQueryExpression();</span>
<span class="nc" id="L242">				return new QueryExpressionCountQuery&lt;&gt;(dynamoDBOperations, entityInformation.getJavaType(),</span>
						queryExpression);

			}
		} else {
<span class="fc" id="L247">			return new ScanExpressionCountQuery&lt;T&gt;(dynamoDBOperations, clazz, buildScanExpression(), pageQuery);</span>
		}
	}

	@Override
	public boolean isApplicableForLoad() {
<span class="fc bfc" id="L253" title="All 4 branches covered.">		return attributeConditions.size() == 0 &amp;&amp; isHashAndRangeKeySpecified();</span>
	}

	protected boolean isHashAndRangeKeySpecified() {
<span class="fc bfc" id="L257" title="All 4 branches covered.">		return isHashKeySpecified() &amp;&amp; isRangeKeySpecified();</span>
	}

	protected boolean isOnlyASingleAttributeConditionAndItIsOnEitherRangeOrIndexRangeKey() {
<span class="fc" id="L261">		boolean isOnlyASingleAttributeConditionAndItIsOnEitherRangeOrIndexRangeKey = false;</span>
<span class="fc bfc" id="L262" title="All 4 branches covered.">		if (!isRangeKeySpecified() &amp;&amp; attributeConditions.size() == 1) {</span>
<span class="fc" id="L263">			Entry&lt;String, List&lt;Condition&gt;&gt; conditionsEntry = attributeConditions.entrySet().iterator().next();</span>
<span class="fc bfc" id="L264" title="All 2 branches covered.">			if (conditionsEntry.getKey().equals(getRangeKeyAttributeName())</span>
<span class="fc bfc" id="L265" title="All 2 branches covered.">					|| getIndexRangeKeyAttributeNames().contains(conditionsEntry.getKey())) {</span>
<span class="pc bpc" id="L266" title="1 of 2 branches missed.">				if (conditionsEntry.getValue().size() == 1) {</span>
<span class="fc" id="L267">					isOnlyASingleAttributeConditionAndItIsOnEitherRangeOrIndexRangeKey = true;</span>
				}
			}
		}
<span class="fc" id="L271">		return isOnlyASingleAttributeConditionAndItIsOnEitherRangeOrIndexRangeKey;</span>

	}

	@Override
	protected boolean hasIndexHashKeyEqualCondition() {

<span class="fc" id="L278">		boolean hasCondition = super.hasIndexHashKeyEqualCondition();</span>
<span class="fc bfc" id="L279" title="All 2 branches covered.">		if (!hasCondition) {</span>
<span class="fc bfc" id="L280" title="All 2 branches covered.">			if (rangeKeyAttributeValue != null</span>
<span class="fc bfc" id="L281" title="All 2 branches covered.">					&amp;&amp; entityInformation.isGlobalIndexHashKeyProperty(rangeKeyPropertyName)) {</span>
<span class="fc" id="L282">				hasCondition = true;</span>
			}
		}
<span class="fc" id="L285">		return hasCondition;</span>
	}

	@Override
	protected boolean hasIndexRangeKeyCondition() {
<span class="fc" id="L290">		boolean hasCondition = super.hasIndexRangeKeyCondition();</span>
<span class="fc bfc" id="L291" title="All 2 branches covered.">		if (!hasCondition) {</span>
<span class="fc bfc" id="L292" title="All 2 branches covered.">			if (rangeKeyAttributeValue != null</span>
<span class="fc bfc" id="L293" title="All 2 branches covered.">					&amp;&amp; entityInformation.isGlobalIndexRangeKeyProperty(rangeKeyPropertyName)) {</span>
<span class="fc" id="L294">				hasCondition = true;</span>
			}
		}
<span class="fc" id="L297">		return hasCondition;</span>
	}

	protected boolean isApplicableForGlobalSecondaryIndex() {
<span class="fc" id="L301">		boolean global = super.isApplicableForGlobalSecondaryIndex();</span>
<span class="fc bfc" id="L302" title="All 4 branches covered.">		if (global &amp;&amp; getRangeKeyAttributeValue() != null &amp;&amp; !entityInformation</span>
<span class="pc bpc" id="L303" title="1 of 2 branches missed.">				.getGlobalSecondaryIndexNamesByPropertyName().keySet().contains(getRangeKeyPropertyName())) {</span>
<span class="nc" id="L304">			return false;</span>
		}

<span class="fc" id="L307">		return global;</span>

	}

	protected String getGlobalSecondaryIndexName() {
		// Get the target global secondary index name using the property
		// conditions
<span class="fc" id="L314">		String globalSecondaryIndexName = super.getGlobalSecondaryIndexName();</span>

		// Hash and Range Entities store range key equals conditions as
		// rangeKeyAttributeValue attribute instead of as property condition
		// Check this attribute and if specified in the query conditions and
		// it's the only global secondary index range candidate,
		// then set the index range key to be that associated with the range key
<span class="fc bfc" id="L321" title="All 2 branches covered.">		if (globalSecondaryIndexName == null) {</span>
<span class="fc bfc" id="L322" title="All 4 branches covered.">			if (this.hashKeyAttributeValue == null &amp;&amp; getRangeKeyAttributeValue() != null) {</span>
<span class="fc" id="L323">				String[] rangeKeyIndexNames = entityInformation.getGlobalSecondaryIndexNamesByPropertyName()</span>
<span class="fc" id="L324">						.get(this.getRangeKeyPropertyName());</span>
<span class="pc bpc" id="L325" title="1 of 4 branches missed.">				globalSecondaryIndexName = rangeKeyIndexNames != null &amp;&amp; rangeKeyIndexNames.length &gt; 0</span>
<span class="fc" id="L326">						? rangeKeyIndexNames[0]</span>
<span class="fc" id="L327">						: null;</span>
			}
		}
<span class="fc" id="L330">		return globalSecondaryIndexName;</span>
	}

	public boolean isApplicableForQuery() {

<span class="fc bfc" id="L335" title="All 2 branches covered.">		return isOnlyHashKeySpecified()</span>
<span class="fc bfc" id="L336" title="All 4 branches covered.">				|| (isHashKeySpecified() &amp;&amp; isOnlyASingleAttributeConditionAndItIsOnEitherRangeOrIndexRangeKey()</span>
<span class="fc bfc" id="L337" title="All 2 branches covered.">						&amp;&amp; comparisonOperatorsPermittedForQuery())</span>
<span class="fc bfc" id="L338" title="All 2 branches covered.">				|| isApplicableForGlobalSecondaryIndex();</span>

	}

	public DynamoDBScanExpression buildScanExpression() {

<span class="fc" id="L344">		ensureNoSort(sort);</span>

<span class="fc" id="L346">		DynamoDBScanExpression scanExpression = new DynamoDBScanExpression();</span>
<span class="fc bfc" id="L347" title="All 2 branches covered.">		if (isHashKeySpecified()) {</span>
<span class="fc" id="L348">			scanExpression.addFilterCondition(getHashKeyAttributeName(),</span>
<span class="fc" id="L349">					createSingleValueCondition(getHashKeyPropertyName(), ComparisonOperator.EQ,</span>
<span class="fc" id="L350">							getHashKeyAttributeValue(), getHashKeyAttributeValue().getClass(), true));</span>
		}
<span class="fc bfc" id="L352" title="All 2 branches covered.">		if (isRangeKeySpecified()) {</span>
<span class="fc" id="L353">			scanExpression.addFilterCondition(getRangeKeyAttributeName(),</span>
<span class="fc" id="L354">					createSingleValueCondition(getRangeKeyPropertyName(), ComparisonOperator.EQ,</span>
<span class="fc" id="L355">							getRangeKeyAttributeValue(), getRangeKeyAttributeValue().getClass(), true));</span>
		}
<span class="fc bfc" id="L357" title="All 2 branches covered.">		for (Map.Entry&lt;String, List&lt;Condition&gt;&gt; conditionEntry : attributeConditions.entrySet()) {</span>
<span class="fc bfc" id="L358" title="All 2 branches covered.">			for (Condition condition : conditionEntry.getValue()) {</span>
<span class="fc" id="L359">				scanExpression.addFilterCondition(conditionEntry.getKey(), condition);</span>
<span class="fc" id="L360">			}</span>
<span class="fc" id="L361">		}</span>
<span class="fc" id="L362">		return scanExpression;</span>
	}

	public DynamoDBQueryCriteria&lt;T, ID&gt; withRangeKeyEquals(Object value) {
<span class="fc" id="L366">		Assert.notNull(value, &quot;Creating conditions on null range keys not supported: please specify a value for '&quot;</span>
<span class="fc" id="L367">				+ getRangeKeyPropertyName() + &quot;'&quot;);</span>

<span class="fc" id="L369">		rangeKeyAttributeValue = getPropertyAttributeValue(getRangeKeyPropertyName(), value);</span>
<span class="fc" id="L370">		rangeKeyPropertyValue = value;</span>
<span class="fc" id="L371">		return this;</span>
	}

	@SuppressWarnings(&quot;unchecked&quot;)
	@Override
	public DynamoDBQueryCriteria&lt;T, ID&gt; withPropertyEquals(String propertyName, Object value, Class&lt;?&gt; propertyType) {
<span class="fc bfc" id="L377" title="All 2 branches covered.">		if (isHashKeyProperty(propertyName)) {</span>
<span class="fc" id="L378">			return withHashKeyEquals(value);</span>
<span class="fc bfc" id="L379" title="All 2 branches covered.">		} else if (isRangeKeyProperty(propertyName)) {</span>
<span class="fc" id="L380">			return withRangeKeyEquals(value);</span>
<span class="fc bfc" id="L381" title="All 2 branches covered.">		} else if (entityInformation.isCompositeHashAndRangeKeyProperty(propertyName)) {</span>
<span class="fc" id="L382">			Assert.notNull(value,</span>
					&quot;Creating conditions on null composite id properties not supported: please specify a value for '&quot;
							+ propertyName + &quot;'&quot;);
<span class="fc" id="L385">			Object hashKey = entityInformation.getHashKey((ID) value);</span>
<span class="fc" id="L386">			Object rangeKey = entityInformation.getRangeKey((ID) value);</span>
<span class="fc bfc" id="L387" title="All 2 branches covered.">			if (hashKey != null) {</span>
<span class="fc" id="L388">				withHashKeyEquals(hashKey);</span>
			}
<span class="fc bfc" id="L390" title="All 2 branches covered.">			if (rangeKey != null) {</span>
<span class="fc" id="L391">				withRangeKeyEquals(rangeKey);</span>
			}
<span class="fc" id="L393">			return this;</span>
		} else {
<span class="fc" id="L395">			Condition condition = createSingleValueCondition(propertyName, ComparisonOperator.EQ, value, propertyType,</span>
					false);
<span class="fc" id="L397">			return withCondition(propertyName, condition);</span>
		}

	}

	@Override
	protected boolean isOnlyHashKeySpecified() {
<span class="pc bpc" id="L404" title="1 of 6 branches missed.">		return isHashKeySpecified() &amp;&amp; attributeConditions.size() == 0 &amp;&amp; !isRangeKeySpecified();</span>
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>